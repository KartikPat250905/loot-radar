validate-ios:
  name: Validate iOS Build
  runs-on: macos-latest
  timeout-minutes: 30

  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew

    - name: Gradle Cache
      uses: gradle/actions/setup-gradle@v3

    - name: Build iOS Framework for Simulator (arm64)
      run: ./gradlew :composeApp:linkDebugFrameworkIosSimulatorArm64 --stacktrace

    - name: Build iOS Framework for Simulator (x64)
      run: ./gradlew :composeApp:linkDebugFrameworkIosX64 --stacktrace

    - name: Build iOS Framework for Device
      run: ./gradlew :composeApp:linkDebugFrameworkIosArm64 --stacktrace

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Build iOS App for Simulator
      working-directory: iosApp
      run: |
        xcodebuild clean build \
          -project iosApp.xcodeproj \
          -scheme iosApp \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO

    - name: Boot iOS Simulator
      run: |
        xcrun simctl list devices available | grep "iPhone 16 Pro"
        xcrun simctl boot "iPhone 16 Pro" || echo "Simulator already booted"
        sleep 15

    - name: Install App on Simulator
      run: |
        APP_PATH=$(find iosApp/build/Build/Products/Debug-iphonesimulator -name "iosApp.app" -type d | head -1)
        echo "Found app at: $APP_PATH"
        xcrun simctl install booted "$APP_PATH"

    - name: Launch App and Take Screenshots
      run: |
        mkdir -p screenshots
        xcrun simctl launch booted com.example.lootradarkmp
        sleep 5
        xcrun simctl io booted screenshot screenshots/01-home-screen.png
        echo "âœ… Captured home screen"

    - name: Shutdown Simulator
      if: always()
      run: |
        xcrun simctl shutdown "iPhone 16 Pro" || echo "Simulator already shut down"

    - name: Upload iOS Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-screenshots
        path: screenshots/*.png
        retention-days: 30

    - name: Upload iOS Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs
        path: |
          iosApp/build/
          composeApp/build/
        retention-days: 7